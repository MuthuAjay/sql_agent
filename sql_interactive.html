<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Agent Interactive Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .config-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .menu-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .menu-card p {
            color: #666;
            line-height: 1.5;
        }

        .menu-card .icon {
            font-size: 2rem;
            margin-bottom: 15px;
            display: block;
        }

        .results-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .results-panel.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .results-panel::-webkit-scrollbar {
            width: 8px;
        }

        .results-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .results-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .results-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #28a745; }
        .status-unhealthy { background: #dc3545; }
        .status-unknown { background: #ffc107; }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            table-layout: auto;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
            margin: 15px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ SQL Agent Test Suite</h1>
            <p>Interactive testing interface for your SQL Agent API</p>
        </div>

        <div class="config-panel">
            <div class="config-grid">
                <div class="input-group">
                    <label for="baseUrl">API Base URL</label>
                    <input type="text" id="baseUrl" value="http://localhost:8000" placeholder="http://localhost:8000">
                </div>
                <div class="input-group">
                    <label for="sessionId">Session ID</label>
                    <input type="text" id="sessionId" readonly>
                </div>
                <button class="btn btn-primary" onclick="connectToAPI()">Connect</button>
            </div>
            <div id="connectionStatus" class="alert" style="display: none; margin-top: 15px;"></div>
        </div>

        <div class="menu-grid">
            <div class="menu-card" onclick="testSystemHealth()">
                <span class="icon">üîç</span>
                <h3>System Health</h3>
                <p>Check API connectivity and service status</p>
            </div>

            <div class="menu-card" onclick="listDatabases()">
                <span class="icon">üóÑÔ∏è</span>
                <h3>List Databases</h3>
                <p>View all available databases in the system</p>
            </div>

            <div class="menu-card" onclick="exploreTables()">
                <span class="icon">üìä</span>
                <h3>Explore Tables</h3>
                <p>Browse tables and their schemas</p>
            </div>

            <div class="menu-card" onclick="getSampleData()">
                <span class="icon">üìà</span>
                <h3>Sample Data</h3>
                <p>View sample data from any table</p>
            </div>

            <div class="menu-card" onclick="naturalLanguageQuery()">
                <span class="icon">üí¨</span>
                <h3>Natural Language Query</h3>
                <p>Ask questions in plain English</p>
            </div>

            <div class="menu-card" onclick="testOrchestrator()">
                <span class="icon">üîß</span>
                <h3>Test Orchestrator</h3>
                <p>Test orchestrator components and functionality</p>
            </div>

            <div class="menu-card" onclick="runFullTestSuite()">
                <span class="icon">üìã</span>
                <h3>Full Test Suite</h3>
                <p>Run comprehensive tests on all components</p>
            </div>

            <div class="menu-card" onclick="performanceTest()">
                <span class="icon">üöÄ</span>
                <h3>Performance Test</h3>
                <p>Test system performance with concurrent requests</p>
            </div>

            <div class="menu-card" onclick="testFraudDetection()">
                <span class="icon">üõ°Ô∏è</span>
                <h3>Fraud Detection</h3>
                <p>Analyze tables for fraud patterns and vulnerabilities</p>
            </div>

            <div class="menu-card" onclick="getFraudScenarios()">
                <span class="icon">üìã</span>
                <h3>Fraud Scenarios</h3>
                <p>View available fraud detection patterns</p>
            </div>

            <div class="menu-card" onclick="testFraudHealth()">
                <span class="icon">‚ù§Ô∏è</span>
                <h3>Fraud Service Health</h3>
                <p>Check fraud detection service status</p>
            </div>
        </div>

        <div id="resultsPanel" class="results-panel">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Processing request...</p>
            </div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="queryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('queryModal')">&times;</span>
                <h3>Natural Language Query</h3>
            </div>
            <div class="form-group">
                <label for="queryInput">Enter your question:</label>
                <textarea id="queryInput" placeholder="e.g., Show me all customers, What are the top products by price?"></textarea>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="includeAnalysis" checked>
                    <label for="includeAnalysis">Include data analysis</label>
                </div>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="includeVisualization">
                    <label for="includeVisualization">Include visualization suggestions</label>
                </div>
            </div>
            <div class="form-group">
                <label for="maxResults">Max Results:</label>
                <input type="number" id="maxResults" value="100" min="1" max="1000">
            </div>
            <button class="btn btn-primary" onclick="executeNaturalLanguageQuery()">Execute Query</button>
        </div>
    </div>

    <div id="sampleDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('sampleDataModal')">&times;</span>
                <h3>Get Sample Data</h3>
            </div>
            <div class="form-group">
                <label for="tableNameInput">Table Name:</label>
                <input type="text" id="tableNameInput" placeholder="Enter table name">
            </div>
            <div class="form-group">
                <label for="limitInput">Number of rows:</label>
                <input type="number" id="limitInput" value="5" min="1" max="100">
            </div>
            <button class="btn btn-primary" onclick="executeSampleData()">Get Sample Data</button>
        </div>
    </div>

    <div id="performanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('performanceModal')">&times;</span>
                <h3>Performance Test Configuration</h3>
            </div>
            <div class="form-group">
                <label for="concurrentQueries">Number of concurrent queries:</label>
                <input type="number" id="concurrentQueries" value="5" min="1" max="50">
            </div>
            <div class="form-group">
                <label for="testDuration">Test duration (seconds):</label>
                <input type="number" id="testDuration" value="30" min="5" max="300">
            </div>
            <button class="btn btn-primary" onclick="executePerformanceTest()">Start Performance Test</button>
        </div>
    </div>

    <div id="fraudDetectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('fraudDetectionModal')">&times;</span>
                <h3>Fraud Detection Analysis</h3>
            </div>
            <div class="form-group">
                <label for="fraudTableName">Table Name:</label>
                <input type="text" id="fraudTableName" placeholder="Enter table name to analyze">
            </div>
            <div class="form-group">
                <label for="fraudAnalysisMode">Analysis Mode:</label>
                <select id="fraudAnalysisMode">
                    <option value="quick">Quick - Fast basic checks</option>
                    <option value="standard" selected>Standard - Comprehensive analysis</option>
                    <option value="deep">Deep - Thorough investigation</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="executeFraudAnalysis()">Analyze for Fraud</button>
        </div>
    </div>

    <script>
        let currentDatabase = null;
        let baseUrl = 'http://localhost:8000';
        let sessionId = `test_${Date.now()}`;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sessionId').value = sessionId;
        });

        async function connectToAPI() {
            const baseUrlInput = document.getElementById('baseUrl');
            baseUrl = baseUrlInput.value.replace(/\/$/, '');
            
            showLoading();
            showResults();
            
            try {
                const response = await fetch(`${baseUrl}/health`);
                const data = await response.json();
                
                hideLoading();
                showConnectionStatus('success', 'Successfully connected to API');
                
                // Update results with connection info
                const html = `
                    <h3>‚úÖ API Connection Successful</h3>
                    <div class="alert alert-success">
                        Connected to: ${baseUrl}<br>
                        Status: ${data.status}<br>
                        Version: ${data.version || 'Unknown'}
                    </div>
                `;
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showConnectionStatus('error', `Failed to connect: ${error.message}`);
                
                const html = `
                    <h3>‚ùå Connection Failed</h3>
                    <div class="alert alert-danger">
                        Could not connect to ${baseUrl}<br>
                        Error: ${error.message}
                    </div>
                `;
                document.getElementById('resultsContent').innerHTML = html;
            }
        }

        async function testSystemHealth() {
            showLoading();
            showResults();
            
            try {
                const [healthResponse, queryResponse, schemaResponse] = await Promise.allSettled([
                    fetch(`${baseUrl}/health`),
                    fetch(`${baseUrl}/api/v1/query/health`),
                    fetch(`${baseUrl}/api/v1/schema/stats`)
                ]);
                
                let html = '<h3>üîç System Health Check</h3>';
                
                // Main API Health
                if (healthResponse.status === 'fulfilled') {
                    const healthData = await healthResponse.value.json();
                    html += createHealthPanel('Main API', healthData, true);
                } else {
                    html += createHealthPanel('Main API', { status: 'unhealthy', error: healthResponse.reason }, false);
                }
                
                // Query Service Health
                if (queryResponse.status === 'fulfilled') {
                    const queryData = await queryResponse.value.json();
                    html += createHealthPanel('Query Service', queryData, true);
                } else {
                    html += createHealthPanel('Query Service', { status: 'unhealthy', error: queryResponse.reason }, false);
                }
                
                // Schema Service Health
                if (schemaResponse.status === 'fulfilled') {
                    const schemaData = await schemaResponse.value.json();
                    html += createHealthPanel('Schema Service', schemaData, true);
                } else {
                    html += createHealthPanel('Schema Service', { status: 'unhealthy', error: schemaResponse.reason }, false);
                }
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showError('System health check failed', error.message);
            }
        }

        function createHealthPanel(serviceName, data, isHealthy) {
            const status = isHealthy ? 'healthy' : 'unhealthy';
            const statusClass = isHealthy ? 'status-healthy' : 'status-unhealthy';
            const alertClass = isHealthy ? 'alert-success' : 'alert-danger';
            
            return `
                <div class="alert ${alertClass}">
                    <h4><span class="status-indicator ${statusClass}"></span>${serviceName}</h4>
                    <p><strong>Status:</strong> ${data.status || status}</p>
                    ${data.version ? `<p><strong>Version:</strong> ${data.version}</p>` : ''}
                    ${data.timestamp ? `<p><strong>Timestamp:</strong> ${data.timestamp}</p>` : ''}
                    ${data.error ? `<p><strong>Error:</strong> ${data.error}</p>` : ''}
                </div>
            `;
        }

        async function listDatabases() {
            showLoading();
            showResults();
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/schema/databases`);
                const databases = await response.json();
                
                let html = '<h3>üóÑÔ∏è Available Databases</h3>';
                
                if (!databases || databases.length === 0) {
                    html += '<div class="alert alert-warning">No databases found</div>';
                } else {
                    html += `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Last Sync</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    databases.forEach(db => {
                        html += `
                            <tr>
                                <td>${db.id || 'unknown'}</td>
                                <td>${db.name || 'unknown'}</td>
                                <td>${db.type || 'unknown'}</td>
                                <td><span class="status-indicator ${getStatusClass(db.status)}"></span>${db.status || 'unknown'}</td>
                                <td>${db.lastSync || 'never'}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="selectDatabase('${db.id}', '${db.name}')">Select</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                }
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showError('Failed to list databases', error.message);
            }
        }

        function getStatusClass(status) {
            if (!status) return 'status-unknown';
            status = status.toLowerCase();
            if (status.includes('healthy') || status === 'active') return 'status-healthy';
            if (status.includes('unhealthy') || status === 'error') return 'status-unhealthy';
            return 'status-unknown';
        }

        async function selectDatabase(id, name) {
            currentDatabase = id;
            showNotification('success', `Selected database: ${name}`);
            await listTablesForDatabase(id);
        }

        async function exploreTables() {
            if (!currentDatabase) {
                showError('No database selected', 'Please select a database first using "List Databases"');
                return;
            }
            
            await listTablesForDatabase(currentDatabase);
        }

        async function listTablesForDatabase(databaseId) {
            showLoading();
            showResults();
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/schema/tables`);
                const data = await response.json();
                
                const tables = Array.isArray(data) ? data : data.tables || [];
                
                let html = `<h3>üìä Tables in Database: ${databaseId}</h3>`;
                
                if (tables.length === 0) {
                    html += '<div class="alert alert-warning">No tables found in database</div>';
                } else {
                    html += `
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Columns</th>
                                        <th>Rows</th>
                                        <th>Size</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    tables.forEach(table => {
                        const rowCount = table.row_count !== null ? table.row_count.toLocaleString() : 'unknown';
                        const size = table.size_bytes ? formatBytes(table.size_bytes) : 'unknown';
                        const description = table.description || 'No description';
                        const truncatedDesc = description.length > 50 ? description.substring(0, 47) + '...' : description;
                        
                        html += `
                            <tr>
                                <td><strong>${table.name || 'unknown'}</strong></td>
                                <td>${table.column_count || 0}</td>
                                <td>${rowCount}</td>
                                <td>${size}</td>
                                <td title="${description}">${truncatedDesc}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="exploreTableSchema('${table.name}')">Schema</button>
                                    <button class="btn btn-success" onclick="showSampleDataModal('${table.name}')">Sample</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    html += `<div class="alert alert-info">Total tables: ${tables.length}</div>`;
                }
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showError('Failed to list tables', error.message);
            }
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + 'GB';
        }

        async function exploreTableSchema(tableName) {
            showLoading();
            showResults();
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/schema/tables/${tableName}`);
                const tableInfo = await response.json();
                
                let html = `<h3>üîé Table Schema: ${tableName}</h3>`;
                
                // Table information
                html += `
                    <div class="alert alert-info">
                        <h4>Table Information</h4>
                        <p><strong>Name:</strong> ${tableInfo.name || tableName}</p>
                        <p><strong>Description:</strong> ${tableInfo.description || 'No description available'}</p>
                        ${tableInfo.row_count ? `<p><strong>Rows:</strong> ${tableInfo.row_count.toLocaleString()}</p>` : ''}
                    </div>
                `;
                
                // Columns
                const columns = tableInfo.columns || [];
                if (columns.length > 0) {
                    html += `
                        <h4>Columns</h4>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Nullable</th>
                                        <th>Key Type</th>
                                        <th>Foreign Key</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    columns.forEach(col => {
                        const keyType = col.primary_key ? 'PRIMARY' : '';
                        const fk = col.foreign_key || '-';
                        const truncatedFk = fk.length > 20 ? fk.substring(0, 17) + '...' : fk;
                        
                        html += `
                            <tr>
                                <td><strong>${col.name || 'unknown'}</strong></td>
                                <td>${col.type || 'unknown'}</td>
                                <td>${col.nullable ? 'YES' : 'NO'}</td>
                                <td>${keyType}</td>
                                <td title="${fk}">${truncatedFk}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-warning">No column information available</div>';
                }
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                if (error.message.includes('404')) {
                    showError('Table not found', `Table '${tableName}' was not found`);
                } else {
                    showError('Failed to explore table schema', error.message);
                }
            }
        }

        function getSampleData() {
            showModal('sampleDataModal');
        }

        function showSampleDataModal(tableName = '') {
            document.getElementById('tableNameInput').value = tableName;
            showModal('sampleDataModal');
        }

        async function executeSampleData() {
            const tableName = document.getElementById('tableNameInput').value.trim();
            const limit = parseInt(document.getElementById('limitInput').value) || 5;
            
            if (!tableName) {
                alert('Please enter a table name');
                return;
            }
            
            closeModal('sampleDataModal');
            showLoading();
            showResults();
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/schema/sample/${tableName}?limit=${limit}`);
                const sampleData = await response.json();
                
                let html = `<h3>üìà Sample Data from ${tableName}</h3>`;
                
                const data = sampleData.data || {};
                const columns = data.columns || [];
                const rows = data.rows || [];
                
                if (columns.length === 0 || rows.length === 0) {
                    html += '<div class="alert alert-warning">No sample data available</div>';
                } else {
                    html += `
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        ${columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    rows.forEach(row => {
                        html += '<tr>';
                        row.forEach(cell => {
                            const cellValue = cell !== null ? String(cell) : 'NULL';
                            html += `<td title="${cellValue}">${cellValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    html += `<div class="alert alert-info">Showing ${rows.length} of ${sampleData.total_returned || rows.length} rows</div>`;
                }
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showError('Failed to get sample data', error.message);
            }
        }

        function naturalLanguageQuery() {
            showModal('queryModal');
        }

        async function executeNaturalLanguageQuery() {
            const query = document.getElementById('queryInput').value.trim();
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            const includeVisualization = document.getElementById('includeVisualization').checked;
            const maxResults = parseInt(document.getElementById('maxResults').value) || 100;
            
            if (!query) {
                alert('Please enter a query');
                return;
            }
            
            closeModal('queryModal');
            showLoading();
            showResults();
            
            const requestData = {
                query: query,
                session_id: sessionId,
                database_name: currentDatabase || 'default',
                include_analysis: includeAnalysis,
                include_visualization: includeVisualization,
                max_results: maxResults
            };
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/query/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                let html = `<h3>üí¨ Natural Language Query Result</h3>`;
                
                // Query analysis
                html += `
                    <div class="alert alert-info">
                        <h4>üß† Query Analysis</h4>
                        <p><strong>Original Query:</strong> "${query}"</p>
                        <p><strong>Intent:</strong> ${result.intent || 'unknown'}</p>
                        <p><strong>Confidence:</strong> ${((result.confidence || 0) * 100).toFixed(1)}%</p>
                        <p><strong>Processing Time:</strong> ${(result.processing_time || 0).toFixed(3)}s</p>
                    </div>
                `;
                
                // SQL Result
                if (result.sql_result) {
                    html += displaySQLResult(result.sql_result);
                }
                
                // Analysis Result
                if (result.analysis_result) {
                    html += displayAnalysisResult(result.analysis_result);
                }
                
                // Suggestions
                if (result.suggestions && result.suggestions.length > 0) {
                    html += `
                        <div class="alert alert-warning">
                            <h4>üí° Suggestions</h4>
                            <ul>
                                ${result.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                showError('Query execution failed', error.message);
            }
        }

        function displaySQLResult(sqlResult) {
            let html = `
                <div class="alert alert-success">
                    <h4>üîç Generated SQL</h4>
                    <div class="code-block">${sqlResult.sql || 'No SQL generated'}</div>
                </div>
            `;
            
            const data = sqlResult.data || [];
            const rowCount = sqlResult.row_count || 0;
            const executionTime = sqlResult.execution_time || 0;
            
            if (data.length > 0) {
                html += `<h4>üìä Query Results (${rowCount} rows, ${executionTime.toFixed(3)}s)</h4>`;
                
                if (rowCount <= 10) {
                    // Show all data for small results
                    const columns = Object.keys(data[0]);
                    html += `
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        ${columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.forEach(row => {
                        html += '<tr>';
                        columns.forEach(col => {
                            const cellValue = row[col] !== null ? String(row[col]) : 'NULL';
                            html += `<td title="${cellValue}">${cellValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                } else {
                    // Show summary for large results
                    html += `
                        <div class="alert alert-info">
                            <p><strong>Total rows:</strong> ${rowCount.toLocaleString()}</p>
                            <p><strong>Execution time:</strong> ${executionTime.toFixed(3)}s</p>
                            <p><strong>Columns:</strong> ${Object.keys(data[0]).join(', ')}</p>
                        </div>
                    `;
                    
                    // Show first few rows
                    const columns = Object.keys(data[0]);
                    html += `
                        <h5>First 5 rows:</h5>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        ${columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.slice(0, 5).forEach(row => {
                        html += '<tr>';
                        columns.forEach(col => {
                            const cellValue = row[col] !== null ? String(row[col]) : 'NULL';
                            html += `<td title="${cellValue}">${cellValue}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
            } else {
                html += '<div class="alert alert-warning">No data returned from query</div>';
            }
            
            return html;
        }

        function displayAnalysisResult(analysisResult) {
            let html = `<h4>üìà Data Analysis</h4>`;
            
            const summary = analysisResult.summary || {};
            if (Object.keys(summary).length > 0) {
                html += '<div class="alert alert-info">';
                html += '<h5>Summary Statistics</h5>';
                if (summary.count) html += `<p><strong>Record count:</strong> ${summary.count.toLocaleString()}</p>`;
                
                const numericCols = summary.numeric_columns || {};
                if (Object.keys(numericCols).length > 0) {
                    html += `<p><strong>Numeric columns:</strong> ${Object.keys(numericCols).length}</p>`;
                }
                
                const categoricalCols = summary.categorical_columns || {};
                if (Object.keys(categoricalCols).length > 0) {
                    html += `<p><strong>Categorical columns:</strong> ${Object.keys(categoricalCols).length}</p>`;
                }
                html += '</div>';
            }
            
            const insights = analysisResult.insights || [];
            if (insights.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <h5>üí° Key Insights</h5>
                        <ul>
                            ${insights.slice(0, 3).map(insight => 
                                `<li>${insight.description || 'No description available'}</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            return html;
        }

        async function testOrchestrator() {
            showLoading();
            showResults();
            
            let html = '<h3>üîß Orchestrator Component Tests</h3>';
            const testResults = [];
            
            // Test 1: Simple Query Endpoint
            try {
                const response = await fetch(`${baseUrl}/api/v1/query/simple`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: "Show me all customers",
                        database_name: currentDatabase || 'default',
                        max_results: 5
                    })
                });
                
                const result = await response.json();
                testResults.push({
                    name: 'Simple Query Endpoint',
                    success: true,
                    details: `Intent: ${result.intent}, SQL generated: ${result.sql ? 'Yes' : 'No'}`
                });
            } catch (error) {
                testResults.push({
                    name: 'Simple Query Endpoint',
                    success: false,
                    details: error.message
                });
            }
            
            // Test 2: Query Validation
            try {
                const response = await fetch(`${baseUrl}/api/v1/query/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: "Show me customer information",
                        database_name: currentDatabase || 'default'
                    })
                });
                
                const validation = await response.json();
                testResults.push({
                    name: 'Query Validation',
                    success: true,
                    details: `Valid: ${validation.is_valid}, Suggestions: ${validation.suggestions ? validation.suggestions.length : 0}`
                });
            } catch (error) {
                testResults.push({
                    name: 'Query Validation',
                    success: false,
                    details: error.message
                });
            }
            
            // Test 3: Service Status
            try {
                const response = await fetch(`${baseUrl}/api/v1/query/status`);
                const status = await response.json();
                testResults.push({
                    name: 'Query Service Status',
                    success: true,
                    details: 'Status retrieved successfully'
                });
            } catch (error) {
                testResults.push({
                    name: 'Query Service Status',
                    success: false,
                    details: error.message
                });
            }
            
            // Display results
            html += `
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Result</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            testResults.forEach(test => {
                const statusIcon = test.success ? '‚úÖ' : '‚ùå';
                const statusClass = test.success ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td>${test.name}</td>
                        <td><span class="${statusClass}">${statusIcon} ${test.success ? 'PASSED' : 'FAILED'}</span></td>
                        <td title="${test.details}">${test.details}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            const passed = testResults.filter(t => t.success).length;
            const total = testResults.length;
            html += `<div class="alert alert-info">Summary: ${passed}/${total} tests passed (${(passed/total*100).toFixed(1)}%)</div>`;
            
            hideLoading();
            document.getElementById('resultsContent').innerHTML = html;
        }

        async function runFullTestSuite() {
            showLoading();
            showResults();
            
            let html = '<h3>üìã Full Test Suite</h3>';
            html += '<div class="progress-bar"><div id="testProgress" class="progress-fill"></div></div>';
            html += '<div id="testStatus">Starting test suite...</div>';
            
            document.getElementById('resultsContent').innerHTML = html;
            
            const tests = [
                { name: 'System Health', func: () => testSystemHealthSilent() },
                { name: 'Database Listing', func: () => listDatabasesSilent() },
                { name: 'Schema Extraction', func: () => testSchemaExtractionSilent() },
                { name: 'Sample Data', func: () => testSampleDataSilent() },
                { name: 'Natural Language Query', func: () => testNLQuerySilent() },
                { name: 'Orchestrator Components', func: () => testOrchestratorSilent() }
            ];
            
            const results = [];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                updateTestProgress((i / tests.length) * 100, `Running: ${test.name}`);
                
                try {
                    await test.func();
                    results.push({ name: test.name, success: true, error: null });
                } catch (error) {
                    results.push({ name: test.name, success: false, error: error.message });
                }
            }
            
            updateTestProgress(100, 'Tests completed');
            
            // Display final results
            setTimeout(() => {
                let finalHtml = '<h3>üìã Full Test Suite Results</h3>';
                
                finalHtml += `
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Test</th>
                                    <th>Result</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                results.forEach(result => {
                    const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                    const statusClass = result.success ? 'text-success' : 'text-danger';
                    finalHtml += `
                        <tr>
                            <td>${result.name}</td>
                            <td><span class="${statusClass}">${statusIcon} ${result.success ? 'PASSED' : 'FAILED'}</span></td>
                            <td title="${result.error || 'Test completed successfully'}">${result.error || 'Test completed successfully'}</td>
                        </tr>
                    `;
                });
                
                finalHtml += '</tbody></table></div>';
                
                const passed = results.filter(r => r.success).length;
                const total = results.length;
                finalHtml += `<div class="alert alert-info">Summary: ${passed}/${total} tests passed (${(passed/total*100).toFixed(1)}%)</div>`;
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = finalHtml;
            }, 1000);
        }

        function updateTestProgress(percentage, status) {
            document.getElementById('testProgress').style.width = percentage + '%';
            document.getElementById('testStatus').textContent = status;
        }

        // Silent test functions (don't update UI)
        async function testSystemHealthSilent() {
            const response = await fetch(`${baseUrl}/health`);
            if (!response.ok) throw new Error('Health check failed');
        }

        async function listDatabasesSilent() {
            const response = await fetch(`${baseUrl}/api/v1/schema/databases`);
            if (!response.ok) throw new Error('Database listing failed');
        }

        async function testSchemaExtractionSilent() {
            const response = await fetch(`${baseUrl}/api/v1/schema/tables`);
            if (!response.ok) throw new Error('Schema extraction failed');
        }

        async function testSampleDataSilent() {
            // Try to get tables first, then sample data from first table
            const tablesResponse = await fetch(`${baseUrl}/api/v1/schema/tables`);
            const data = await tablesResponse.json();
            const tables = Array.isArray(data) ? data : data.tables || [];
            
            if (tables.length > 0) {
                const sampleResponse = await fetch(`${baseUrl}/api/v1/schema/sample/${tables[0].name}?limit=1`);
                if (!sampleResponse.ok) throw new Error('Sample data retrieval failed');
            }
        }

        async function testNLQuerySilent() {
            const response = await fetch(`${baseUrl}/api/v1/query/simple`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: "Test query",
                    database_name: currentDatabase || 'default',
                    max_results: 1
                })
            });
            if (!response.ok) throw new Error('Natural language query failed');
        }

        async function testOrchestratorSilent() {
            const response = await fetch(`${baseUrl}/api/v1/query/status`);
            if (!response.ok) throw new Error('Orchestrator test failed');
        }

        function performanceTest() {
            showModal('performanceModal');
        }

        async function executePerformanceTest() {
            const concurrentQueries = parseInt(document.getElementById('concurrentQueries').value) || 5;
            const testDuration = parseInt(document.getElementById('testDuration').value) || 30;
            
            closeModal('performanceModal');
            showLoading();
            showResults();
            
            let html = '<h3>üöÄ Performance Test</h3>';
            html += '<div class="progress-bar"><div id="perfProgress" class="progress-fill"></div></div>';
            html += '<div id="perfStatus">Starting performance test...</div>';
            html += '<div id="perfStats"></div>';
            
            document.getElementById('resultsContent').innerHTML = html;
            
            const startTime = Date.now();
            const endTime = startTime + (testDuration * 1000);
            let completedQueries = 0;
            let failedQueries = 0;
            const responseTimes = [];
            
            async function singleQuery(queryId) {
                const queryStart = Date.now();
                try {
                    const response = await fetch(`${baseUrl}/api/v1/query/simple`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: `Performance test query ${queryId}`,
                            database_name: currentDatabase || 'default',
                            max_results: 5
                        })
                    });
                    
                    const queryEnd = Date.now();
                    const responseTime = queryEnd - queryStart;
                    responseTimes.push(responseTime);
                    completedQueries++;
                    
                    return { success: true, responseTime };
                } catch (error) {
                    failedQueries++;
                    return { success: false, error: error.message };
                }
            }
            
            // Run performance test
            const runConcurrentQueries = async () => {
                const promises = [];
                for (let i = 0; i < concurrentQueries; i++) {
                    promises.push(singleQuery(Date.now() + i));
                }
                await Promise.all(promises);
            };
            
            const testInterval = setInterval(async () => {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                const progress = Math.min((elapsed / testDuration) * 100, 100);
                
                document.getElementById('perfProgress').style.width = progress + '%';
                document.getElementById('perfStatus').textContent = `Running... ${elapsed.toFixed(1)}s / ${testDuration}s`;
                
                // Update stats
                const avgResponseTime = responseTimes.length > 0 ? responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length : 0;
                const qps = elapsed > 0 ? completedQueries / elapsed : 0;
                
                document.getElementById('perfStats').innerHTML = `
                    <div class="alert alert-info">
                        <p><strong>Completed Queries:</strong> ${completedQueries}</p>
                        <p><strong>Failed Queries:</strong> ${failedQueries}</p>
                        <p><strong>Queries/Second:</strong> ${qps.toFixed(2)}</p>
                        <p><strong>Avg Response Time:</strong> ${avgResponseTime.toFixed(0)}ms</p>
                    </div>
                `;
                
                if (now >= endTime) {
                    clearInterval(testInterval);
                    displayPerformanceResults();
                } else {
                    await runConcurrentQueries();
                }
            }, 1000);
            
            function displayPerformanceResults() {
                const totalTime = (Date.now() - startTime) / 1000;
                const avgResponseTime = responseTimes.length > 0 ? responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length : 0;
                const minResponseTime = responseTimes.length > 0 ? Math.min(...responseTimes) : 0;
                const maxResponseTime = responseTimes.length > 0 ? Math.max(...responseTimes) : 0;
                const successRate = completedQueries + failedQueries > 0 ? (completedQueries / (completedQueries + failedQueries)) * 100 : 0;
                const qps = totalTime > 0 ? completedQueries / totalTime : 0;
                
                let finalHtml = '<h3>üöÄ Performance Test Results</h3>';
                
                finalHtml += `
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Test Duration</td><td>${totalTime.toFixed(1)}s</td></tr>
                                <tr><td>Total Queries</td><td>${completedQueries + failedQueries}</td></tr>
                                <tr><td>Successful Queries</td><td>${completedQueries}</td></tr>
                                <tr><td>Failed Queries</td><td>${failedQueries}</td></tr>
                                <tr><td>Success Rate</td><td>${successRate.toFixed(1)}%</td></tr>
                                <tr><td>Queries per Second</td><td>${qps.toFixed(2)}</td></tr>
                                <tr><td>Avg Response Time</td><td>${avgResponseTime.toFixed(0)}ms</td></tr>
                                <tr><td>Min Response Time</td><td>${minResponseTime}ms</td></tr>
                                <tr><td>Max Response Time</td><td>${maxResponseTime}ms</td></tr>
                            </tbody>
                        </table>
                    </div>
                `;
                
                hideLoading();
                document.getElementById('resultsContent').innerHTML = finalHtml;
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingIndicator').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.remove('active');
        }

        function showResults() {
            document.getElementById('resultsPanel').classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showError(title, message) {
            const html = `
                <h3>‚ùå ${title}</h3>
                <div class="alert alert-danger">
                    ${message}
                </div>
            `;
            document.getElementById('resultsContent').innerHTML = html;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        // Handle Enter key in forms
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    const modalId = activeModal.id;
                    if (modalId === 'queryModal') {
                        executeNaturalLanguageQuery();
                    } else if (modalId === 'sampleDataModal') {
                        executeSampleData();
                    } else if (modalId === 'performanceModal') {
                        executePerformanceTest();
                    } else if (modalId === 'fraudDetectionModal') {
                        executeFraudAnalysis();
                    }
                }
            }
        });

        // Fraud Detection Functions
        function testFraudDetection() {
            showModal('fraudDetectionModal');
        }

        async function executeFraudAnalysis() {
            const tableName = document.getElementById('fraudTableName').value.trim();
            const analysisMode = document.getElementById('fraudAnalysisMode').value;

            if (!tableName) {
                alert('Please enter a table name');
                return;
            }

            closeModal('fraudDetectionModal');
            showLoading();
            showResults();

            try {
                const response = await fetch(`${baseUrl}/api/v1/fraud/analyze?table_name=${encodeURIComponent(tableName)}&analysis_mode=${analysisMode}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Fraud analysis failed');
                }

                const result = await response.json();

                let html = `<h3>üõ°Ô∏è Fraud Detection Analysis: ${tableName}</h3>`;

                // Summary section
                const summary = result.summary || {};
                const riskClass = getRiskClass(summary.highest_risk_level || 'low');
                const riskIcon = getRiskIcon(summary.highest_risk_level || 'low');

                html += `
                    <div class="alert alert-${riskClass}">
                        <h4>${riskIcon} Analysis Summary</h4>
                        <p><strong>Analysis Mode:</strong> ${result.analysis_mode || 'unknown'}</p>
                        <p><strong>Scenarios Detected:</strong> ${summary.total_scenarios_detected || 0}</p>
                        <p><strong>Highest Risk Level:</strong> ${summary.highest_risk_level || 'low'}</p>
                        <p><strong>Detectors Run:</strong> ${summary.detectors_run || 0}</p>
                        <p><strong>Detectors Failed:</strong> ${summary.detectors_failed || 0}</p>
                        <p><strong>Processing Time:</strong> ${(result.processing_time || 0).toFixed(3)}s</p>
                        <p><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                    </div>
                `;

                // Detection results by detector type
                const detectionResults = result.detection_results || {};
                html += '<h4>Detection Results by Category</h4>';

                for (const [detectorName, detectorResult] of Object.entries(detectionResults)) {
                    if (detectorResult) {
                        html += displayDetectorResults(detectorName, detectorResult);
                    } else {
                        html += `
                            <div class="alert alert-warning">
                                <h5>${formatDetectorName(detectorName)}</h5>
                                <p>‚ö†Ô∏è Detector failed to run</p>
                            </div>
                        `;
                    }
                }

                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;

            } catch (error) {
                hideLoading();
                showError('Fraud analysis failed', error.message);
            }
        }

        function displayDetectorResults(detectorName, result) {
            const scenarios = result.scenarios || [];
            const detectorTitle = formatDetectorName(detectorName);

            let html = `<div class="alert alert-info">`;
            html += `<h5>${detectorTitle}</h5>`;

            if (scenarios.length === 0) {
                html += '<p>‚úÖ No fraud patterns detected</p>';
            } else {
                html += `<p>Found ${scenarios.length} potential fraud scenario(s)</p>`;
                html += '<div class="table-wrapper"><table class="table"><thead><tr>';
                html += '<th>Pattern</th><th>Risk Level</th><th>Confidence</th><th>Description</th><th>Recommendation</th>';
                html += '</tr></thead><tbody>';

                scenarios.forEach(scenario => {
                    const riskIcon = getRiskIcon(scenario.risk_level || 'low');
                    const riskClass = getRiskClass(scenario.risk_level || 'low');

                    html += `
                        <tr>
                            <td><strong>${scenario.pattern_name || 'Unknown'}</strong></td>
                            <td><span class="alert-${riskClass}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px;">${riskIcon} ${(scenario.risk_level || 'low').toUpperCase()}</span></td>
                            <td>${((scenario.confidence || 0) * 100).toFixed(0)}%</td>
                            <td title="${scenario.description || ''}">${truncateText(scenario.description || 'No description', 50)}</td>
                            <td title="${scenario.recommendation || ''}">${truncateText(scenario.recommendation || 'No recommendation', 50)}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            }

            html += '</div>';
            return html;
        }

        async function getFraudScenarios() {
            showLoading();
            showResults();

            try {
                const response = await fetch(`${baseUrl}/api/v1/fraud/scenarios`);

                if (!response.ok) {
                    throw new Error('Failed to fetch fraud scenarios');
                }

                const result = await response.json();
                const scenarios = result.scenarios || [];
                const categories = result.categories || [];

                let html = '<h3>üìã Fraud Detection Scenarios</h3>';

                html += `
                    <div class="alert alert-info">
                        <p><strong>Total Scenarios:</strong> ${result.total_scenarios || 0}</p>
                        <p><strong>Categories:</strong> ${categories.join(', ')}</p>
                    </div>
                `;

                if (scenarios.length === 0) {
                    html += '<div class="alert alert-warning">No fraud scenarios available</div>';
                } else {
                    // Group by category
                    const scenariosByCategory = {};
                    scenarios.forEach(scenario => {
                        const category = scenario.category || 'Unknown';
                        if (!scenariosByCategory[category]) {
                            scenariosByCategory[category] = [];
                        }
                        scenariosByCategory[category].push(scenario);
                    });

                    // Display by category
                    for (const [category, categoryScenarios] of Object.entries(scenariosByCategory)) {
                        html += `<h4>${category}</h4>`;
                        html += '<div class="table-wrapper"><table class="table"><thead><tr>';
                        html += '<th>Pattern</th><th>Risk Level</th><th>Description</th><th>Detection Method</th>';
                        html += '</tr></thead><tbody>';

                        categoryScenarios.forEach(scenario => {
                            const riskIcon = getRiskIcon(scenario.risk_level || 'low');
                            const riskClass = getRiskClass(scenario.risk_level || 'low');

                            html += `
                                <tr>
                                    <td><strong>${scenario.name || 'Unknown'}</strong></td>
                                    <td><span class="alert-${riskClass}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px;">${riskIcon} ${(scenario.risk_level || 'low').toUpperCase()}</span></td>
                                    <td title="${scenario.description || ''}">${truncateText(scenario.description || '', 80)}</td>
                                    <td>${scenario.detection_method || 'N/A'}</td>
                                </tr>
                            `;
                        });

                        html += '</tbody></table></div>';
                    }
                }

                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;

            } catch (error) {
                hideLoading();
                showError('Failed to get fraud scenarios', error.message);
            }
        }

        async function testFraudHealth() {
            showLoading();
            showResults();

            try {
                const response = await fetch(`${baseUrl}/api/v1/fraud/health`);

                if (!response.ok) {
                    throw new Error('Fraud service health check failed');
                }

                const healthData = await response.json();

                let html = '<h3>‚ù§Ô∏è Fraud Detection Service Health</h3>';

                const isHealthy = healthData.status === 'healthy';
                const statusClass = isHealthy ? 'status-healthy' : 'status-unhealthy';
                const alertClass = isHealthy ? 'alert-success' : 'alert-danger';

                html += `
                    <div class="alert ${alertClass}">
                        <h4><span class="status-indicator ${statusClass}"></span>Service Status</h4>
                        <p><strong>Status:</strong> ${healthData.status || 'unknown'}</p>
                        <p><strong>Timestamp:</strong> ${new Date(healthData.timestamp).toLocaleString()}</p>
                    </div>
                `;

                // Detectors status
                const detectors = healthData.detectors || {};
                if (Object.keys(detectors).length > 0) {
                    html += '<h4>Fraud Detectors</h4>';
                    html += '<div class="table-wrapper"><table class="table"><thead><tr>';
                    html += '<th>Detector</th><th>Status</th>';
                    html += '</tr></thead><tbody>';

                    for (const [detectorName, status] of Object.entries(detectors)) {
                        const isAvailable = status === 'available';
                        const detectorStatusClass = isAvailable ? 'status-healthy' : 'status-unhealthy';

                        html += `
                            <tr>
                                <td><strong>${formatDetectorName(detectorName)}</strong></td>
                                <td><span class="status-indicator ${detectorStatusClass}"></span>${status}</td>
                            </tr>
                        `;
                    }

                    html += '</tbody></table></div>';
                }

                // Configuration
                const config = healthData.config || {};
                if (Object.keys(config).length > 0) {
                    html += `
                        <h4>Configuration</h4>
                        <div class="alert alert-info">
                            <p><strong>Enabled:</strong> ${config.enabled ? 'Yes' : 'No'}</p>
                            <p><strong>Analysis Mode:</strong> ${config.analysis_mode || 'unknown'}</p>
                            <p><strong>Timeout:</strong> ${config.timeout || 0}s</p>
                            <p><strong>Confidence Threshold:</strong> ${((config.confidence_threshold || 0) * 100).toFixed(0)}%</p>
                            <p><strong>Risk Level Threshold:</strong> ${config.risk_threshold || 'medium'}</p>
                        </div>
                    `;
                }

                hideLoading();
                document.getElementById('resultsContent').innerHTML = html;

            } catch (error) {
                hideLoading();
                showError('Fraud service health check failed', error.message);
            }
        }

        // Fraud helper functions
        function formatDetectorName(name) {
            const nameMap = {
                'transaction': 'üí≥ Transaction Fraud',
                'schema': 'üîí Schema Vulnerability',
                'temporal': '‚è∞ Temporal Anomaly',
                'statistical': 'üìä Statistical Anomaly',
                'relationship': 'üîó Relationship Integrity'
            };
            return nameMap[name] || name.charAt(0).toUpperCase() + name.slice(1);
        }

        function getRiskIcon(riskLevel) {
            const icons = {
                'low': 'üü¢',
                'medium': 'üü°',
                'high': 'üü†',
                'critical': 'üî¥'
            };
            return icons[riskLevel.toLowerCase()] || '‚ö™';
        }

        function getRiskClass(riskLevel) {
            const classes = {
                'low': 'info',
                'medium': 'warning',
                'high': 'warning',
                'critical': 'danger'
            };
            return classes[riskLevel.toLowerCase()] || 'info';
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }
    </script>
</body>
</html>